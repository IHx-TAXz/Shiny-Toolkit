{% extends "base.html" %}

{% block title %}Report Issue - Shiny Portal{% endblock %}

{% block content %}
<div class="report-issue-page">
    <div class="issue-header">
        <h1><i class="fas fa-bug"></i> Report an Issue</h1>
        <p class="issue-subtitle">Help us improve Shiny Portal by reporting bugs or suggesting features</p>
    </div>

    <div class="issue-container">
        <div class="issue-form-container">
            <form id="issue-form" class="issue-form">
                <div class="form-section">
                    <h3><i class="fas fa-info-circle"></i> Issue Information</h3>
                    
                    <div class="form-group">
                        <label for="issue-type"><i class="fas fa-tag"></i> Issue Type *</label>
                        <select id="issue-type" name="issue-type" required>
                            <option value="">Select issue type...</option>
                            <option value="bug">üêõ Bug Report</option>
                            <option value="feature">üí° Feature Request</option>
                            <option value="ui">üé® UI/UX Improvement</option>
                            <option value="documentation">üìö Documentation</option>
                            <option value="security">üîí Security Concern</option>
                            <option value="other">‚ùì Other</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="issue-title"><i class="fas fa-heading"></i> Title *</label>
                        <input type="text" id="issue-title" name="issue-title" placeholder="Brief description of the issue" required>
                    </div>

                    <div class="form-group">
                        <label for="issue-description"><i class="fas fa-file-alt"></i> Description *</label>
                        <textarea id="issue-description" name="issue-description" rows="6" placeholder="Please provide a detailed description of the issue..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-steps"></i> Steps to Reproduce</h3>
                    <div class="form-group">
                        <label for="issue-steps"><i class="fas fa-list-ol"></i> Steps *</label>
                        <textarea id="issue-steps" name="issue-steps" rows="4" placeholder="1. Go to...
2. Click on...
3. Observe that..." required></textarea>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-desktop"></i> Environment</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="browser"><i class="fas fa-globe"></i> Browser</label>
                            <input type="text" id="browser" name="browser" placeholder="Chrome, Firefox, Safari...">
                        </div>
                        <div class="form-group">
                            <label for="os"><i class="fas fa-laptop"></i> Operating System</label>
                            <input type="text" id="os" name="os" placeholder="Windows, macOS, Linux...">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="shiny-version"><i class="fas fa-code-branch"></i> Shiny Portal Version</label>
                        <input type="text" id="shiny-version" name="shiny-version" value="1.0.0" readonly>
                    </div>
                </div>

                <div class="form-section">
                    <h3><i class="fas fa-paperclip"></i> Additional Information</h3>
                    <div class="form-group">
                        <label for="expected-behavior"><i class="fas fa-check-circle"></i> Expected Behavior</label>
                        <textarea id="expected-behavior" name="expected-behavior" rows="3" placeholder="What did you expect to happen?"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="actual-behavior"><i class="fas fa-times-circle"></i> Actual Behavior</label>
                        <textarea id="actual-behavior" name="actual-behavior" rows="3" placeholder="What actually happened?"></textarea>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="btn-primary">
                        <i class="fas fa-paper-plane"></i> Submit Issue Report
                    </button>
                    <button type="reset" class="btn-secondary">
                        <i class="fas fa-undo"></i> Reset Form
                    </button>
                </div>
            </form>
        </div>

        <div class="issue-guidelines">
            <div class="guidelines-card">
                <h3><i class="fas fa-clipboard-list"></i> Reporting Guidelines</h3>
                
                <div class="guideline-item">
                    <h4>üêõ For Bug Reports</h4>
                    <ul>
                        <li>Provide clear steps to reproduce</li>
                        <li>Include error messages or screenshots</li>
                        <li>Specify your environment details</li>
                        <li>Mention what you expected vs what happened</li>
                    </ul>
                </div>

                <div class="guideline-item">
                    <h4>üí° For Feature Requests</h4>
                    <ul>
                        <li>Explain the problem you're trying to solve</li>
                        <li>Describe your proposed solution</li>
                        <li>Provide use cases or examples</li>
                        <li>Consider if others would benefit from this</li>
                    </ul>
                </div>

                <div class="guideline-item">
                    <h4>üö´ What to Avoid</h4>
                    <ul>
                        <li>Don't report security issues here (email instead)</li>
                        <li>Avoid vague descriptions like "it doesn't work"</li>
                        <li>Don't include sensitive information</li>
                        <li>Avoid duplicate reports - check existing issues first</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loading" class="loading hidden">
    <div class="spinner"></div>
    <p>Submitting your issue...</p>
</div>

<!-- Success Modal -->
<div id="success-modal" class="modal hidden">
    <div class="modal-content">
        <div class="success-icon">
            <i class="fas fa-check-circle"></i>
        </div>
        <h3>Issue Reported Successfully!</h3>
        <p>Thank you for helping improve Shiny Portal. We'll review your issue and get back to you if we need more information.</p>
        <div class="modal-actions">
            <button id="success-close" class="btn-primary">Close</button>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const issueForm = document.getElementById('issue-form');
    const loading = document.getElementById('loading');
    const successModal = document.getElementById('success-modal');

    if (issueForm) {
        issueForm.addEventListener('submit', function(e) {
            e.preventDefault();
            submitIssue();
        });

        document.getElementById('success-close').addEventListener('click', function() {
            successModal.classList.add('hidden');
        });
    }

    function submitIssue() {
        const formData = new FormData(issueForm);
        
        // Kumpulkan data ke dalam objek JSON
        const issueData = {
            type: formData.get('issue-type'),
            title: formData.get('issue-title'),
            description: formData.get('issue-description'),
            steps: formData.get('issue-steps'),
            browser: formData.get('browser'),
            os: formData.get('os'),
            version: formData.get('shiny-version'),
            expected: formData.get('expected-behavior'),
            actual: formData.get('actual-behavior'),
            timestamp: new Date().toISOString()
        };

        loading.classList.remove('hidden');

        // Panggilan API yang sebenarnya ke Flask
        fetch('/submit_issue', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json' // Beri tahu Flask bahwa body adalah JSON
            },
            body: JSON.stringify(issueData)
        })
        // Tangkap respons (dan status HTTP)
        .then(response => response.json().then(data => ({ status: response.status, body: data })))
        .then(result => {
            loading.classList.add('hidden');

            if (result.status === 200 && result.body.success) {
                // Sukses dikirim oleh Flask dan Telegram
                successModal.classList.remove('hidden');
                issueForm.reset();
            } else {
                // Kegagalan dari server Flask (misal: gagal kirim ke Telegram)
                alert('Gagal melaporkan isu. Pesan Server: ' + (result.body.message || result.body.error || 'Terjadi kesalahan tidak dikenal.'));
            }
        })
        .catch(error => {
            // Error jaringan (server Flask mati, dll.)
            loading.classList.add('hidden');
            alert('Error jaringan: Gagal terhubung ke server Flask.');
            console.error('Fetch error:', error);
        });
    }
});
</script>
{% endblock %}
